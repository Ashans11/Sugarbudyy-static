<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SugarBuddy — 2‑Hour Post‑Meal Tracker</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Recharts (UMD) -->
  <script crossorigin src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  <!-- Framer Motion (UMD) -->
  <script crossorigin src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>
  <style>
    html, body { background: #fff; }
    .card { border-radius: 1rem; border: 1px solid #e5e7eb; background: #fff; }
    .toast { position: fixed; left: 0; right: 0; bottom: 16px; display:flex; justify-content:center; pointer-events:none; }
    .toast > div { pointer-events:auto; padding:.6rem .9rem; border-radius:.75rem; box-shadow:0 10px 25px rgba(0,0,0,.1); background:#111827; color:#fff; font-size:.9rem; }
    .slider-fill { transition: width .5s cubic-bezier(.2,.8,.2,1); }
  </style>
</head>
<body class="text-slate-900">
  <div id="app" class="max-w-md mx-auto p-4"></div>
  <div id="toast-root" class="toast" style="display:none"><div id="toast-msg"></div></div>

  <script>
  (function(){
    const { useState, useEffect, useMemo } = React;
    const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine } = Recharts;
    const motion = window['framer-motion'];

    // --- Constants ---
    const TARGET_2HR = 120; // mg/dL
    const STORAGE_KEY = 'sugarbuddy-v2';
    const MGDL_PER_MMOLL = 18; // 1 mmol/L = 18 mg/dL
    const MEALS = [
      { key: 'breakfast', label: 'Breakfast' },
      { key: 'lunch', label: 'Lunch' },
      { key: 'dinner', label: 'Dinner' },
    ];

    // --- Helpers ---
    const todayStr = () => new Date(Date.now()).toISOString().slice(0,10);
    const fromUnit = (val, unit) => unit === 'mgdl' ? Math.round(val) : Math.round(val * MGDL_PER_MMOLL);
    function showToast(msg){
      const root = document.getElementById('toast-root');
      const box = document.getElementById('toast-msg');
      box.textContent = msg; root.style.display = 'flex';
      clearTimeout(showToast._t); showToast._t = setTimeout(()=>{ root.style.display='none'; }, 1800);
    }

    function ConfettiMini({ show }){
      return React.createElement('div', { className:'relative h-5 w-5 overflow-visible' },
        show ? React.createElement(motion.motion.div, {
          initial:{ scale:0, opacity:0, rotate:-15 },
          animate:{ scale:1, opacity:1, rotate:0 },
          transition:{ type:'spring', stiffness:300, damping:20 },
          className:'absolute -top-2 -right-2 text-lg'
        }, '✨') : null
      );
    }

    function TargetSlider({ readingMgdl, unit }){
      const maxMgdl = 180;
      const max = unit === 'mgdl' ? maxMgdl : maxMgdl / MGDL_PER_MMOLL;
      const value = typeof readingMgdl === 'number' ? (unit === 'mgdl' ? readingMgdl : readingMgdl / MGDL_PER_MMOLL) : 0;
      const pct = Math.min(100, (Math.min(value, max) / max) * 100);
      const target = unit === 'mgdl' ? TARGET_2HR : TARGET_2HR / MGDL_PER_MMOLL;
      const inRange = typeof readingMgdl === 'number' && (readingMgdl <= TARGET_2HR);

      return React.createElement('div', { className:'w-full' },
        React.createElement('div', { className:'relative h-3 rounded-full bg-slate-200 overflow-hidden' },
          React.createElement('div', { className:'absolute top-0 bottom-0', style:{ left: ((target / max) * 100) + '%' } },
            React.createElement('div', { className:'w-[2px] h-full bg-emerald-500' })
          ),
          React.createElement('div', { className: 'h-full slider-fill ' + (inRange ? 'bg-emerald-400' : 'bg-rose-400'), style:{ width: pct + '%' } })
        ),
        React.createElement('div', { className:'flex justify-between text-[10px] mt-1 text-slate-500' },
          React.createElement('span', null, '0'),
          React.createElement('span', null, 'Target ' + (unit==='mgdl' ? Math.round(target) : target.toFixed(1))),
          React.createElement('span', null, unit==='mgdl' ? Math.round(max) : max.toFixed(1))
        )
      );
    }

    function buildCSV(logs, unit){
      const unitLabel = unit === 'mgdl' ? 'mg/dL' : 'mmol/L';
      const headers = ['Date','Meal','Test Time',`Reading (${unitLabel})`];
      const rows = [];
      Object.keys(logs).sort().forEach(d => {
        MEALS.forEach(m => {
          const entry = (logs[d]||{})[m.key] || {};
          const val = typeof entry.reading === 'number' ? (unit==='mgdl' ? Math.round(entry.reading) : (entry.reading / MGDL_PER_MMOLL).toFixed(1)) : '';
          rows.push([ d, m.label, entry.time || '', val ]);
        });
      });
      return [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    }

    function App(){
      const [name, setName] = useState('Mama');
      const [dueDate, setDueDate] = useState(()=>{
        const now = new Date();
        const year = now.getMonth() > 10 ? now.getFullYear() + 1 : now.getFullYear();
        return `${year}-11-05`;
      });
      const [unit, setUnit] = useState('mgdl');
      const [date, setDate] = useState(todayStr());
      const [logs, setLogs] = useState({});

      useEffect(()=>{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          try { const s = JSON.parse(raw);
            s.name && setName(s.name);
            s.dueDate && setDueDate(s.dueDate);
            s.date && setDate(s.date);
            s.unit && setUnit(s.unit);
            s.logs && setLogs(s.logs);
          } catch {}
        }
      },[]);
      useEffect(()=>{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ name, dueDate, date, unit, logs }));
      },[name, dueDate, date, unit, logs]);

      useEffect(()=>{
        setLogs(prev => {
          if (prev[date]) return prev;
          const next = { ...prev };
          next[date] = { breakfast:{time:'',reading:null}, lunch:{time:'',reading:null}, dinner:{time:'',reading:null} };
          return next;
        });
      },[date]);

      const dueDays = useMemo(()=>{
        const d = new Date(dueDate + 'T00:00:00');
        const diff = Math.ceil((d.getTime() - Date.now()) / (1000*60*60*24));
        return Math.max(diff, 0);
      },[dueDate]);

      function updateMeal(mealKey, patch){
        setLogs(prev => ({ ...prev, [date]: { ...prev[date], [mealKey]: { ...prev[date]?.[mealKey], ...patch } } }));
      }
      function exportCSV(){
        const csv = buildCSV(logs, unit);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'sugarbuddy-readings.csv'; a.click();
        URL.revokeObjectURL(url);
      }

      const chartData = useMemo(()=>{
        const list = [];
        Object.keys(logs).forEach(d => {
          MEALS.forEach(m => {
            const r = (logs[d]||{})[m.key]?.reading;
            if (typeof r === 'number') list.push({ time: `${d} ${m.label}`, value: unit==='mgdl' ? Math.round(r) : (r/MGDL_PER_MMOLL) });
          });
        });
        return list;
      },[logs, unit]);

      const pct7 = useMemo(()=>{
        const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-7);
        let total=0, inRange=0;
        Object.keys(logs).forEach(d => {
          const dt = new Date(d+'T00:00:00');
          if (dt >= cutoff) {
            MEALS.forEach(m => {
              const r = (logs[d]||{})[m.key]?.reading;
              if (typeof r === 'number'){ total++; if (r <= TARGET_2HR) inRange++; }
            });
          }
        });
        return total ? Math.round((inRange/total)*100) : 0;
      },[logs]);

      const dayLog = logs[date] || {};

      return React.createElement('div', { className:'min-h-screen bg-white text-slate-900' },
        // Header
        React.createElement('div', { className:'flex items-center justify-between' },
          React.createElement('div', { className:'flex items-center gap-2' },
            React.createElement('div', { className:'text-2xl' }, '🍼'),
            React.createElement('h1', { className:'text-xl font-bold' }, 'SugarBuddy'),
            React.createElement('span', { className:'ml-2 text-xs bg-slate-100 px-2 py-1 rounded-full' }, 'Cute GD')
          ),
          React.createElement('div', { className:'flex items-center gap-2' },
            React.createElement('div', { className:'text-[11px] border rounded-xl overflow-hidden' },
              React.createElement('button', { className:'px-2 py-1 ' + (unit==='mgdl'?'bg-slate-900 text-white':'bg-white'), onClick:()=>setUnit('mgdl') }, 'mg/dL'),
              React.createElement('button', { className:'px-2 py-1 ' + (unit==='mmol'?'bg-slate-900 text-white':'bg-white'), onClick:()=>setUnit('mmol') }, 'mmol/L')
            ),
            React.createElement('button', { className:'rounded-xl border px-3 py-1 text-sm', onClick: exportCSV }, 'Export')
          )
        ),

        // Hello + countdown
        React.createElement('div', { className:'card mt-3 p-3' },
          React.createElement('div', { className:'text-base font-semibold flex items-center gap-1' }, 'Hello, ', name, ' ', '✨'),
          React.createElement('div', { className:'grid grid-cols-2 gap-2 mt-2' },
            React.createElement('div', null,
              React.createElement('label', { className:'text-xs block mb-1' }, 'Your name'),
              React.createElement('input', { className:'w-full border rounded-lg px-3 py-2', value:name, onChange:e=>setName(e.target.value), placeholder:'e.g., Mama, Amma' })
            ),
            React.createElement('div', null,
              React.createElement('label', { className:'text-xs block mb-1' }, 'Due date'),
              React.createElement('input', { type:'date', className:'w-full border rounded-lg px-3 py-2', value:dueDate, onChange:e=>setDueDate(e.target.value) }),
              React.createElement('p', { className:'text-[10px] text-slate-500 mt-1' }, (function(){ const d = new Date(dueDate+'T00:00:00'); const diff=Math.ceil((d.getTime()-Date.now())/(864e5)); return Math.max(diff,0); })(), ' day(s) to go')
            )
          )
        ),

        // Date picker
        React.createElement('div', { className:'card mt-3 p-3' },
          React.createElement('div', { className:'text-base font-semibold flex items-center gap-2' }, '📅', 'Pick a date'),
          React.createElement('div', { className:'grid gap-2 mt-2' },
            React.createElement('input', { type:'date', className:'w-full border rounded-lg px-3 py-2', value:date, onChange:e=>setDate(e.target.value) }),
            React.createElement('p', { className:'text-xs text-slate-500' }, 'Add readings for the selected day. No schedules or reminders — just clean logging.')
          )
        ),

        // Today’s plan
        React.createElement('div', { className:'card mt-3 p-3' },
          React.createElement('div', { className:'text-base font-semibold' }, 'Today’s plan (test-only)'),
          React.createElement('div', { className:'space-y-3 mt-2' },
            MEALS.map(m => {
              const entry = dayLog[m.key] || { time:'', reading:null };
              const inRange = typeof entry.reading === 'number' && entry.reading <= TARGET_2HR;
              return React.createElement('div', { key:m.key, className:'p-3 rounded-xl border bg-white' },
                React.createElement('div', { className:'flex items-center justify-between' },
                  React.createElement('div', { className:'flex items-center gap-2' }, '⏱️', React.createElement('div', { className:'font-medium' }, m.label)),
                  React.createElement('div', { className:'flex items-center gap-2' }, React.createElement(ConfettiMini, { show: inRange }))
                ),
                React.createElement('div', { className:'mt-2 grid grid-cols-2 gap-2' },
                  React.createElement('div', null,
                    React.createElement('label', { className:'text-xs block mb-1' }, 'Test time'),
                    React.createElement('input', { type:'time', className:'w-full border rounded-lg px-3 py-2', value:entry.time, onChange:e=>updateMeal(m.key,{ time:e.target.value }) })
                  ),
                  React.createElement('div', null,
                    React.createElement('label', { className:'text-xs block mb-1' }, 'Reading (' + (unit==='mgdl'?'mg/dL':'mmol/L') + ')'),
                    React.createElement('input', { type:'number', inputMode:'decimal', className:'w-full border rounded-lg px-3 py-2',
                      placeholder:(unit==='mgdl'?'e.g., 112':'e.g., 6.2'),
                      value: entry.reading==null? '': (unit==='mgdl'? Math.round(entry.reading): (entry.reading / MGDL_PER_MMOLL).toFixed(1)),
                      onChange:e=>{ const val = e.target.value; const raw = val===''? null: Number(val); const mgdl = raw==null? null: fromUnit(raw, unit); updateMeal(m.key,{ reading: mgdl }); if(typeof mgdl==='number'){ if(mgdl<=TARGET_2HR) showToast('Target hit! Baby’s doing a happy wiggle.'); else showToast('Logged. We’ll nudge closer next meal.'); } }
                    })
                  )
                ),
                React.createElement('div', { className:'mt-3' }, React.createElement(TargetSlider, { readingMgdl: entry.reading, unit })) ,
                typeof entry.reading === 'number' ? React.createElement('div', { className:'mt-1 text-xs' }, inRange ? React.createElement('span', { className:'text-emerald-600' }, 'In range ≤ ', (unit==='mgdl'? TARGET_2HR : (TARGET_2HR/MGDL_PER_MMOLL).toFixed(1)), ' ', (unit==='mgdl'?'mg/dL':'mmol/L'), '. Lovely work!') : React.createElement('span', { className:'text-rose-600' }, 'Above target. A short post‑meal walk can help.')) : null
              );
            })
          )
        ),

        // Streaks & Trends
        React.createElement('div', { className:'card mt-3 p-3' },
          React.createElement('div', { className:'text-base font-semibold flex items-center gap-2' }, '🏆', 'Last 7 days in range'),
          React.createElement('div', { className:'w-full bg-slate-200 h-2 rounded-full mt-2 overflow-hidden' },
            React.createElement('div', { className:'h-2 bg-emerald-500', style:{ width: pct7 + '%' } })
          ),
          React.createElement('p', { className:'text-xs text-slate-500 mt-1' }, pct7 + '% of readings ≤ ' + (unit==='mgdl'? TARGET_2HR : (TARGET_2HR/MGDL_PER_MMOLL).toFixed(1)) + ' ' + (unit==='mgdl'?'mg/dL':'mmol/L'))
        ),

        React.createElement('div', { className:'card mt-3 p-3 h-80' },
          React.createElement('div', { className:'text-base font-semibold' }, 'Trends'),
          chartData.length===0 ? React.createElement('div', { className:'text-sm text-slate-500 mt-2' }, 'Add a few readings to see your progress ✨') :
          React.createElement(ResponsiveContainer, { width:'100%', height:'100%' },
            React.createElement(LineChart, { data: chartData, margin:{ left:8, right:8, top:8, bottom:8 } },
              React.createElement(CartesianGrid, { strokeDasharray:'3 3' }),
              React.createElement(XAxis, { dataKey:'time', hide:true }),
              React.createElement(YAxis, { domain: (unit==='mgdl' ? [60, Math.max(160, Math.max.apply(null, chartData.map(d=>d.value))+10)] : [3, Math.max(10, Math.max.apply(null, chartData.map(d=>d.value))+1)]) }),
              React.createElement(Tooltip, null),
              React.createElement(ReferenceLine, { y: (unit==='mgdl'? TARGET_2HR : (TARGET_2HR/MGDL_PER_MMOLL)), strokeDasharray:'4 4' }),
              React.createElement(Line, { type:'monotone', dataKey:'value', dot:true })
            )
          )
        ),

        // Meal ideas
        React.createElement('div', { className:'card mt-3 mb-8 p-3' },
          React.createElement('div', { className:'text-base font-semibold' }, 'Simple meal & snack ideas'),
          React.createElement('ul', { className:'list-disc pl-5 space-y-1 text-sm mt-2' },
            React.createElement('li', null, 'Breakfast: egg omelette + greens; Greek yoghurt + chia + berries'),
            React.createElement('li', null, 'Lunch: rice (small) + dal + protein (fish/chicken/tofu) + salad'),
            React.createElement('li', null, 'Dinner: stir‑fried veg + paneer/chicken; quinoa bowl'),
            React.createElement('li', null, 'Snacks: apple + peanut butter; kiri yoghurt + nuts; hummus + carrots'),
            React.createElement('li', null, 'Tip: 10–15 min walk after main meals helps the 2‑hour number.')
          ),
          React.createElement('p', { className:'text-[11px] text-slate-500 mt-2' }, 'Targets: 2‑hour post‑meal ≤ ', (unit==='mgdl'? TARGET_2HR : (TARGET_2HR/MGDL_PER_MMOLL).toFixed(1)), ' ', (unit==='mgdl'?'mg/dL':'mmol/L'), '. Not a medical device — follow your clinician’s advice.')
        )
      );
    }

    // Mount
    ReactDOM.createRoot(document.getElementById('app')).render(React.createElement(App));

  })();
  </script>
</body>
</html>
